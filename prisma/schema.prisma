generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                       String  @id
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  User                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model BaseDocument {
  id               String             @id
  title            String
  type             DocumentType
  userId           String
  thumbnailUrl     String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  isPublic         Boolean            @default(false)
  documentType     String
  User             User               @relation(fields: [userId], references: [id])
  FavoriteDocument FavoriteDocument[]
  Presentation     Presentation?
}

model ChatConversation {
  id          String        @id
  userId      String
  title       String?
  context     String
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  User        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  ChatMessage ChatMessage[]

  @@index([context])
  @@index([userId])
}

model ChatMessage {
  id               String           @id
  conversationId   String
  userId           String
  role             String
  content          String
  metadata         Json?
  createdAt        DateTime         @default(now())
  ChatConversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId])
}

model CreditTransaction {
  id          String   @id
  userId      String
  amount      Int
  type        String
  description String
  operation   String?
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([type])
  @@index([userId])
}

model CustomTheme {
  id           String         @id
  name         String
  description  String?
  userId       String
  logoUrl      String?
  isPublic     Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  themeData    Json
  User         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  Presentation Presentation[]

  @@index([userId])
}

model DeepResearchReport {
  id             String   @id
  userId         String
  topic          String
  status         String
  filePath       String
  markdown       String
  pmidsUsed      Json?
  wordCount      Int?
  referenceCount Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

model Document {
  id        String   @id
  title     String
  content   String
  type      String
  sources   String?
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([userId])
}

model FavoriteDocument {
  id           String       @id
  documentId   String
  userId       String
  BaseDocument BaseDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User         User         @relation(fields: [userId], references: [id])
}

model GeneratedImage {
  id        String   @id
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime
  userId    String
  prompt    String
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id                String   @id
  userId            String
  amount            Float
  currency          String
  status            String
  plan              String
  creditsAdded      Int
  stripePaymentId   String?  @unique
  razorpayPaymentId String?  @unique
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model Presentation {
  id                String       @id
  content           Json
  theme             String       @default("default")
  imageSource       String       @default("ai")
  prompt            String?
  presentationStyle String?
  language          String?      @default("en-US")
  outline           String[]
  searchResults     Json?
  templateId        String?
  customThemeId     String?
  CustomTheme       CustomTheme? @relation(fields: [customThemeId], references: [id])
  BaseDocument      BaseDocument @relation(fields: [id], references: [id], onDelete: Cascade)
}

model TokenUsage {
  id            String   @id
  userId        String
  operation     String
  operationId   String?
  inputTokens   Int
  outputTokens  Int
  totalTokens   Int
  modelProvider String
  modelId       String
  inputCost     Float
  outputCost    Float
  totalCost     Float
  metadata      Json?
  createdAt     DateTime @default(now())
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([modelProvider])
  @@index([operation])
  @@index([userId, createdAt])
  @@index([userId])
}

model User {
  id                 String               @id
  name               String?
  email              String?              @unique
  password           String?
  emailVerified      DateTime?
  image              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now())
  headline           String?              @db.VarChar(100)
  bio                String?
  interests          String[]
  location           String?
  website            String?
  role               UserRole             @default(USER)
  hasAccess          Boolean              @default(false)
  credits            Int                  @default(100)
  stripeCustomerId   String?              @unique
  subscriptionEnd    DateTime?
  subscriptionPlan   String               @default("free")
  totalInputTokens   Int                  @default(0)
  totalOutputTokens  Int                  @default(0)
  totalTokens        Int                  @default(0)
  totalTokenCost     Float                @default(0)
  subscriptionStart  DateTime?
  lastCreditRefresh  DateTime?
  Account            Account[]
  BaseDocument       BaseDocument[]
  ChatConversation   ChatConversation[]
  ChatMessage        ChatMessage[]
  CreditTransaction  CreditTransaction[]
  CustomTheme        CustomTheme[]
  DeepResearchReport DeepResearchReport[]
  Document           Document[]
  FavoriteDocument   FavoriteDocument[]
  GeneratedImage     GeneratedImage[]
  Payment            Payment[]
  TokenUsage         TokenUsage[]
  PdfDocument        PdfDocument[]
  PdfCollection      PdfCollection[]
  MedicalChunk       MedicalChunk[]
  MedicalEntity      MedicalEntity[]
  PdfChatSession     PdfChatSession[]
  // File Manager relations
  FileCollections    FileCollection[]
  UserFiles          UserFile[]

  @@index([lastCreditRefresh])
  @@index([subscriptionEnd])
  @@index([subscriptionPlan])
}

// =====================================================
// PDF Chat RAG Models
// =====================================================

model PdfDocument {
  id              String            @id @default(uuid()) @db.Uuid
  userId          String            @map("user_id")
  collectionId    String?           @map("collection_id") @db.Uuid
  filename        String
  originalName    String            @map("original_filename")
  fileUrl         String            @map("file_url")
  fileSize        Int               @map("file_size")
  pageCount       Int?              @map("page_count")
  status          String            @default("pending")
  processingError String?           @map("error_message")
  metadata        Json?
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  User            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  PdfCollection   PdfCollection?    @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  MedicalChunk    MedicalChunk[]
  MedicalEntity   MedicalEntity[]
  PdfChatSession  PdfChatSession[]

  @@index([userId])
  @@index([collectionId])
  @@index([status])
  @@index([createdAt])
  @@map("pdf_documents")
}

model MedicalChunk {
  id          String      @id @default(uuid()) @db.Uuid
  documentId  String      @db.Uuid
  userId      String
  chunkIdx    Int
  chunkText   String      @db.Text
  pageNumber  Int
  tokenCount  Int
  embedding   Unsupported("vector(768)")
  metadata    Json?
  createdAt   DateTime    @default(now())
  PdfDocument PdfDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([pageNumber])
}

model MedicalEntity {
  id              String      @id @default(uuid()) @db.Uuid
  documentId      String      @db.Uuid
  userId          String
  entityName      String
  entityType      String
  entityText      String
  startChar       Int?
  endChar         Int?
  confidenceScore Float       @default(0.8)
  createdAt       DateTime    @default(now())
  PdfDocument     PdfDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([entityType])
  @@index([entityName])
}

model PdfCollection {
  id                String           @id @default(uuid()) @db.Uuid
  userId            String           @map("user_id")
  name              String
  description       String?
  fileSearchStoreId String?          @map("file_search_store_id") // Gemini File Search Store ID
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  User              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  PdfDocument       PdfDocument[]
  PdfChatSession    PdfChatSession[]

  @@index([userId])
  @@index([createdAt])
  @@map("pdf_collections")
}

model PdfChatSession {
  id             String           @id @default(uuid()) @db.Uuid
  collectionId   String?          @map("collection_id") @db.Uuid
  documentId     String?          @map("document_id") @db.Uuid
  userId         String           @map("user_id")
  title          String?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  PdfCollection  PdfCollection?   @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  PdfDocument    PdfDocument?     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  PdfChatMessage PdfChatMessage[]

  @@index([collectionId])
  @@index([documentId])
  @@index([userId])
  @@index([createdAt])
  @@map("pdf_chat_sessions")
}

model PdfChatMessage {
  id              String         @id @default(uuid()) @db.Uuid
  sessionId       String         @map("session_id") @db.Uuid
  role            String
  content         String         @db.Text
  sources         Json?
  confidenceScore Float?         @map("confidence_score")
  createdAt       DateTime       @default(now()) @map("created_at")
  PdfChatSession  PdfChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("pdf_chat_messages")
}

enum DocumentType {
  NOTE
  DOCUMENT
  DRAWING
  DESIGN
  STICKY_NOTES
  MIND_MAP
  RAG
  RESEARCH_PAPER
  FLIPBOOK
  PRESENTATION
}

enum UserRole {
  ADMIN
  USER
}

// =====================================================
// File Manager Models
// =====================================================

model FileCollection {
  id                String                 @id @default(uuid()) @db.Uuid
  userId            String                 @map("user_id")
  name              String
  description       String?
  color             String                 @default("#3b82f6")
  icon              String                 @default("folder")
  isSmart           Boolean                @default(false) @map("is_smart")
  smartFilter       Json?                  @map("smart_filter")
  fileCount         Int                    @default(0) @map("file_count")
  // Share link fields
  shareLink         String?                @unique @map("share_link")
  shareLinkEnabled  Boolean                @default(false) @map("share_link_enabled")
  shareLinkAccess   String                 @default("public") @map("share_link_access")
  shareLinkRole     String                 @default("viewer") @map("share_link_role")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  User              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  UserFiles         UserFile[]
  FileCollectionFiles FileCollectionFile[]
  CollectionMembers CollectionMember[]
  CollectionPresence CollectionPresence[]

  @@index([userId])
  @@index([shareLink])
  @@map("file_collections")
}

model UserFile {
  id              String              @id @default(uuid()) @db.Uuid
  userId          String              @map("user_id")
  collectionId    String?             @map("collection_id") @db.Uuid
  // File info
  filename        String
  originalName    String              @map("original_name")
  fileUrl         String              @map("file_url")
  fileKey         String?             @map("file_key")
  storageProvider String              @default("wasabi") @map("storage_provider")
  fileType        String              @map("file_type")
  mimeType        String?             @map("mime_type")
  fileSize        Int                 @default(0) @map("file_size")
  thumbnailUrl    String?             @map("thumbnail_url")
  // Processing status
  status          String              @default("ready")
  processingError String?             @map("processing_error")
  isIndexed       Boolean             @default(false) @map("is_indexed")
  // Content extraction
  extractedText   String?             @map("extracted_text") @db.Text
  pageCount       Int?                @map("page_count")
  wordCount       Int?                @map("word_count")
  // AI metadata
  aiSummary       String?             @map("ai_summary") @db.Text
  aiCategory      String?             @map("ai_category")
  // User metadata
  isFavorite      Boolean             @default(false) @map("is_favorite")
  isGenerated     Boolean             @default(false) @map("is_generated")
  sourceFeature   String?             @map("source_feature")
  // Timestamps
  lastAccessedAt  DateTime?           @map("last_accessed_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  User            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  FileCollection  FileCollection?     @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  FileTags        FileTag[]
  FileChunks      FileChunk[]
  FileCollectionFiles FileCollectionFile[]

  @@index([userId])
  @@index([collectionId])
  @@index([fileType])
  @@index([isFavorite])
  @@index([isGenerated])
  @@index([createdAt])
  @@map("user_files")
}

model FileCollectionFile {
  id           String         @id @default(uuid()) @db.Uuid
  fileId       String         @map("file_id") @db.Uuid
  collectionId String         @map("collection_id") @db.Uuid
  addedAt      DateTime       @default(now()) @map("added_at")
  UserFile     UserFile       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  FileCollection FileCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([fileId, collectionId])
  @@index([fileId])
  @@index([collectionId])
  @@map("file_collection_files")
}

model FileTag {
  id            String   @id @default(uuid()) @db.Uuid
  fileId        String   @map("file_id") @db.Uuid
  tagName       String   @map("tag_name")
  tagType       String   @default("manual") @map("tag_type")
  confidence    Float    @default(1.0)
  color         String   @default("#6b7280")
  isAiGenerated Boolean  @default(false) @map("is_ai_generated")
  createdAt     DateTime @default(now()) @map("created_at")
  UserFile      UserFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([fileId, tagName])
  @@index([fileId])
  @@index([tagName])
  @@map("file_tags")
}

model FileChunk {
  id            String   @id @default(uuid()) @db.Uuid
  fileId        String   @map("file_id") @db.Uuid
  chunkIndex    Int      @map("chunk_index")
  content       String   @db.Text
  embedding     Unsupported("vector(1536)")?
  startPosition Int?     @map("start_position")
  endPosition   Int?     @map("end_position")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  UserFile      UserFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@map("file_chunks")
}

model CollectionMember {
  id           String         @id @default(uuid()) @db.Uuid
  collectionId String         @map("collection_id") @db.Uuid
  userId       String?        @map("user_id")
  email        String
  role         String         @default("viewer")
  status       String         @default("pending")
  invitedBy    String         @map("invited_by")
  invitedAt    DateTime       @default(now()) @map("invited_at")
  acceptedAt   DateTime?      @map("accepted_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  FileCollection FileCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, email])
  @@index([collectionId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@map("collection_members")
}

model CollectionPresence {
  id           String         @id @default(uuid()) @db.Uuid
  collectionId String         @map("collection_id") @db.Uuid
  odId         String         @map("user_id")
  userEmail    String?        @map("user_email")
  userName     String?        @map("user_name")
  userAvatar   String?        @map("user_avatar")
  lastSeen     DateTime       @default(now()) @map("last_seen")
  isActive     Boolean        @default(true) @map("is_active")
  FileCollection FileCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, odId])
  @@index([collectionId])
  @@index([isActive])
  @@map("collection_presence")
}

// =====================================================
// Video Streaming Models (Agora)
// =====================================================

model StreamingRoom {
  id                    String                 @id @default(uuid()) @db.Uuid
  hostId                String                 @map("host_id")
  title                 String
  description           String?
  roomCode              String                 @unique @map("room_code")
  status                String                 @default("waiting") // waiting, live, ended, scheduled
  isRecording           Boolean                @default(false) @map("is_recording")
  maxParticipants       Int                    @default(100) @map("max_participants")
  allowChat             Boolean                @default(true) @map("allow_chat")
  allowRaiseHand        Boolean                @default(true) @map("allow_raise_hand")
  waitingRoomEnabled    Boolean                @default(false) @map("waiting_room_enabled")
  createdAt             DateTime               @default(now()) @map("created_at")
  startedAt             DateTime?              @map("started_at")
  endedAt               DateTime?              @map("ended_at")
  totalParticipants     Int                    @default(0) @map("total_participants")
  peakParticipants      Int                    @default(0) @map("peak_participants")
  totalDurationSeconds  Int                    @default(0) @map("total_duration_seconds")
  
  // Scheduling fields
  scheduledAt           DateTime?              @map("scheduled_at")
  scheduledEndAt        DateTime?              @map("scheduled_end_at")
  timezone              String?                @default("UTC")
  isRecurring           Boolean                @default(false) @map("is_recurring")
  recurrenceRule        String?                @map("recurrence_rule")
  
  Participants          StreamingParticipant[]
  ChatMessages          StreamChatMessage[]
  Recordings            StreamRecording[]

  @@index([hostId])
  @@index([roomCode])
  @@index([status])
  @@index([scheduledAt])
  @@map("streaming_rooms")
}

model StreamingParticipant {
  id              String        @id @default(uuid()) @db.Uuid
  roomId          String        @map("room_id") @db.Uuid
  userId          String        @map("user_id")
  role            String        @default("viewer") // host, co-host, viewer
  isMuted         Boolean       @default(true) @map("is_muted")
  isVideoOn       Boolean       @default(false) @map("is_video_on")
  handRaised      Boolean       @default(false) @map("hand_raised")
  isInWaitingRoom Boolean       @default(false) @map("is_in_waiting_room")
  joinedAt        DateTime      @default(now()) @map("joined_at")
  leftAt          DateTime?     @map("left_at")
  
  StreamingRoom   StreamingRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@map("streaming_participants")
}

model StreamChatMessage {
  id            String        @id @default(uuid()) @db.Uuid
  roomId        String        @map("room_id") @db.Uuid
  userId        String        @map("user_id")
  message       String
  isPinned      Boolean       @default(false) @map("is_pinned")
  createdAt     DateTime      @default(now()) @map("created_at")
  
  StreamingRoom StreamingRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId, createdAt])
  @@map("stream_chat_messages")
}

model StreamRecording {
  id              String        @id @default(uuid()) @db.Uuid
  roomId          String        @map("room_id") @db.Uuid
  fileUrl         String?       @map("file_url")
  fileSizeBytes   BigInt?       @map("file_size_bytes")
  durationSeconds Int?          @map("duration_seconds")
  status          String        @default("processing") // processing, ready, failed
  createdAt       DateTime      @default(now()) @map("created_at")
  
  StreamingRoom   StreamingRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@map("stream_recordings")
}

// =====================================================
// Sponsored Ads Models (for video.biodocs.ai integration)
// =====================================================

// Ad Campaign - Created by admins/sponsors
model AdCampaign {
  id                String         @id @default(uuid()) @db.Uuid
  sponsorName       String         @map("sponsor_name")
  sponsorLogo       String?        @map("sponsor_logo")
  message           String?
  url               String
  ctaText           String         @default("Learn More") @map("cta_text")
  
  // Targeting criteria (stored as JSON for flexibility)
  // { specialties: [], locations: [], roomTypes: [], userIds: [], userEmails: [] }
  targeting         Json?
  
  // Campaign schedule
  startDate         DateTime       @map("start_date")
  endDate           DateTime       @map("end_date")
  
  // Budget & billing
  budget            Float          @default(0)
  spent             Float          @default(0)
  costPerImpression Float          @default(0) @map("cost_per_impression")
  costPerClick      Float          @default(0) @map("cost_per_click")
  
  // Stats (denormalized for quick access)
  impressions       Int            @default(0)
  clicks            Int            @default(0)
  
  // Status
  active            Boolean        @default(true)
  approved          Boolean        @default(false) // Admin approval required
  
  // Audit
  createdBy         String?        @map("created_by")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  
  // Relations
  AdImpressions     AdImpression[]

  @@index([active, startDate, endDate])
  @@index([sponsorName])
  @@index([createdAt])
  @@map("ad_campaigns")
}

// Ad Impression - Tracks when an ad is shown
model AdImpression {
  id            String      @id @default(uuid()) @db.Uuid
  campaignId    String      @map("campaign_id") @db.Uuid
  
  // Context
  roomId        String?     @map("room_id")
  userId        String?     @map("user_id")
  
  // User context for analytics (optional, for targeting analysis)
  userSpecialty String?     @map("user_specialty")
  userLocation  String?     @map("user_location")
  roomType      String?     @map("room_type")
  
  // Tracking
  clicked       Boolean     @default(false)
  clickedAt     DateTime?   @map("clicked_at")
  dismissed     Boolean     @default(false)
  dismissedAt   DateTime?   @map("dismissed_at")
  
  // Technical
  userAgent     String?     @map("user_agent")
  ipAddress     String?     @map("ip_address")
  
  createdAt     DateTime    @default(now()) @map("created_at")
  
  // Relations
  AdCampaign    AdCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([userId])
  @@index([roomId])
  @@index([createdAt])
  @@index([clicked])
  @@map("ad_impressions")
}

// Sponsor accounts for self-service ad management (optional)
model AdSponsor {
  id           String   @id @default(uuid()) @db.Uuid
  companyName  String   @map("company_name")
  contactEmail String   @unique @map("contact_email")
  contactName  String?  @map("contact_name")
  logoUrl      String?  @map("logo_url")
  website      String?
  
  // Billing
  balance      Float    @default(0)
  
  // Status
  verified     Boolean  @default(false)
  active       Boolean  @default(true)
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([contactEmail])
  @@index([companyName])
  @@map("ad_sponsors")
}
// Groups System Models
// =====================================================

model Group {
  id                      String                 @id @default(uuid()) @db.Uuid
  name                    String
  description             String?
  avatarUrl               String?                @map("avatar_url")
  createdBy               String                 @map("created_by")
  groupType               String                 @default("private") @map("group_type")
  maxMembers              Int                    @default(256) @map("max_members")
  onlyAdminsCanMessage    Boolean                @default(false) @map("only_admins_can_message")
  onlyAdminsCanAddMembers Boolean                @default(false) @map("only_admins_can_add_members")
  muteNotifications       Boolean                @default(false) @map("mute_notifications")
  inviteCode              String?                @unique @map("invite_code")
  inviteLinkEnabled       Boolean                @default(true) @map("invite_link_enabled")
  createdAt               DateTime               @default(now()) @map("created_at")
  updatedAt               DateTime               @updatedAt @map("updated_at")
  GroupMembers            GroupMember[]
  GroupMessages           GroupMessage[]
  GroupMedia              GroupMedia[]
  GroupStreamShares       GroupStreamShare[]
  GroupTypingIndicators   GroupTypingIndicator[]
  GroupPolls              GroupPoll[]
  GroupAnnotations        GroupAnnotation[]

  @@index([createdBy])
  @@index([inviteCode])
  @@index([groupType])
  @@index([createdAt(sort: Desc)])
  @@map("groups")
}

model GroupMember {
  id                   String   @id @default(uuid()) @db.Uuid
  groupId              String   @map("group_id") @db.Uuid
  userId               String   @map("user_id")
  role                 String   @default("member")
  isMuted              Boolean  @default(false) @map("is_muted")
  notificationsEnabled Boolean  @default(true) @map("notifications_enabled")
  addedBy              String?  @map("added_by")
  lastReadAt           DateTime @default(now()) @map("last_read_at")
  joinedAt             DateTime @default(now()) @map("joined_at")
  Group                Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([groupId, role])
  @@map("group_members")
}

model GroupMessage {
  id                    String                 @id @default(uuid()) @db.Uuid
  groupId               String                 @map("group_id") @db.Uuid
  senderId              String                 @map("sender_id")
  content               String?                @db.Text
  messageType           String                 @default("text") @map("message_type")
  replyToId             String?                @map("reply_to_id") @db.Uuid
  metadata              Json?                  @default("{}")
  isEdited              Boolean                @default(false) @map("is_edited")
  editedAt              DateTime?              @map("edited_at")
  isDeleted             Boolean                @default(false) @map("is_deleted")
  deletedAt             DateTime?              @map("deleted_at")
  deletedForEveryone    Boolean                @default(false) @map("deleted_for_everyone")
  isPinned              Boolean                @default(false) @map("is_pinned")
  pinnedAt              DateTime?              @map("pinned_at")
  pinnedBy              String?                @map("pinned_by")
  linkPreview           Json?                  @map("link_preview")
  createdAt             DateTime               @default(now()) @map("created_at")
  Group                 Group                  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  ReplyTo               GroupMessage?          @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  Replies               GroupMessage[]         @relation("MessageReplies")
  GroupMedia            GroupMedia[]
  GroupMessageReads     GroupMessageRead[]
  GroupMessageReactions GroupMessageReaction[]
  GroupMessageMentions  GroupMessageMention[]
  GroupPolls            GroupPoll[]

  @@index([groupId])
  @@index([senderId])
  @@index([groupId, createdAt(sort: Desc)])
  @@index([messageType])
  @@index([replyToId])
  @@index([groupId, isPinned])
  @@map("group_messages")
}

model GroupMedia {
  id               String            @id @default(uuid()) @db.Uuid
  groupId          String            @map("group_id") @db.Uuid
  messageId        String?           @map("message_id") @db.Uuid
  uploadedBy       String            @map("uploaded_by")
  fileName         String            @map("file_name")
  fileUrl          String            @map("file_url")
  fileKey          String?           @map("file_key")
  fileType         String            @map("file_type")
  mimeType         String?           @map("mime_type")
  fileSize         Int?              @map("file_size")
  width            Int?
  height           Int?
  thumbnailUrl     String?           @map("thumbnail_url")
  pageCount        Int?              @map("page_count")
  createdAt        DateTime          @default(now()) @map("created_at")
  Group            Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  GroupMessage     GroupMessage?     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  GroupAnnotations GroupAnnotation[]

  @@index([groupId])
  @@index([messageId])
  @@index([uploadedBy])
  @@index([fileType])
  @@index([createdAt(sort: Desc)])
  @@map("group_media")
}

model GroupStreamShare {
  id                String   @id @default(uuid()) @db.Uuid
  groupId           String   @map("group_id") @db.Uuid
  messageId         String?  @map("message_id") @db.Uuid
  streamRoomId      String   @map("stream_room_id") @db.Uuid
  sharedBy          String   @map("shared_by")
  streamTitle       String?  @map("stream_title")
  streamDescription String?  @map("stream_description")
  roomCode          String?  @map("room_code")
  sharedAt          DateTime @default(now()) @map("shared_at")
  Group             Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([streamRoomId])
  @@index([sharedBy])
  @@map("group_stream_shares")
}

model GroupMessageRead {
  id           String       @id @default(uuid()) @db.Uuid
  messageId    String       @map("message_id") @db.Uuid
  userId       String       @map("user_id")
  readAt       DateTime     @default(now()) @map("read_at")
  GroupMessage GroupMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@map("group_message_reads")
}

model GroupTypingIndicator {
  id        String   @id @default(uuid()) @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  userId    String   @map("user_id")
  startedAt DateTime @default(now()) @map("started_at")
  Group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@map("group_typing_indicators")
}

model GroupMessageReaction {
  id           String       @id @default(uuid()) @db.Uuid
  messageId    String       @map("message_id") @db.Uuid
  userId       String       @map("user_id")
  emoji        String
  createdAt    DateTime     @default(now()) @map("created_at")
  GroupMessage GroupMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@index([emoji])
  @@map("group_message_reactions")
}

model GroupMessageMention {
  id              String       @id @default(uuid()) @db.Uuid
  messageId       String       @map("message_id") @db.Uuid
  mentionedUserId String       @map("mentioned_user_id")
  createdAt       DateTime     @default(now()) @map("created_at")
  GroupMessage    GroupMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, mentionedUserId])
  @@index([messageId])
  @@index([mentionedUserId])
  @@map("group_message_mentions")
}

model GroupPoll {
  id               String          @id @default(uuid()) @db.Uuid
  groupId          String          @map("group_id") @db.Uuid
  messageId        String?         @map("message_id") @db.Uuid
  createdBy        String          @map("created_by")
  question         String
  options          Json            @default("[]")
  isMultipleChoice Boolean         @default(false) @map("is_multiple_choice")
  isAnonymous      Boolean         @default(false) @map("is_anonymous")
  allowAddOptions  Boolean         @default(false) @map("allow_add_options")
  isClosed         Boolean         @default(false) @map("is_closed")
  endsAt           DateTime?       @map("ends_at")
  closedAt         DateTime?       @map("closed_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  Group            Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  GroupMessage     GroupMessage?   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  GroupPollVotes   GroupPollVote[]

  @@index([groupId])
  @@index([messageId])
  @@index([createdBy])
  @@index([groupId, isClosed])
  @@map("group_polls")
}

model GroupPollVote {
  id        String    @id @default(uuid()) @db.Uuid
  pollId    String    @map("poll_id") @db.Uuid
  optionId  String    @map("option_id")
  userId    String    @map("user_id")
  createdAt DateTime  @default(now()) @map("created_at")
  GroupPoll GroupPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)

  @@unique([pollId, optionId, userId])
  @@index([pollId])
  @@index([userId])
  @@index([pollId, optionId])
  @@map("group_poll_votes")
}

model GroupAnnotation {
  id             String            @id @default(uuid()) @db.Uuid
  groupId        String            @map("group_id") @db.Uuid
  mediaId        String?           @map("media_id") @db.Uuid
  createdBy      String            @map("created_by")
  content        String
  annotationType String            @default("highlight") @map("annotation_type")
  positionData   Json?             @map("position_data")
  color          String            @default("#FFEB3B")
  parentId       String?           @map("parent_id") @db.Uuid
  isResolved     Boolean           @default(false) @map("is_resolved")
  resolvedAt     DateTime?         @map("resolved_at")
  resolvedBy     String?           @map("resolved_by")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  Group          Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  GroupMedia     GroupMedia?       @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  Parent         GroupAnnotation?  @relation("AnnotationReplies", fields: [parentId], references: [id], onDelete: Cascade)
  Replies        GroupAnnotation[] @relation("AnnotationReplies")

  @@index([groupId])
  @@index([mediaId])
  @@index([createdBy])
  @@index([parentId])
  @@map("group_annotations")
}
