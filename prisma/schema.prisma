generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                       String  @id
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  User                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model BaseDocument {
  id               String             @id
  title            String
  type             DocumentType
  userId           String
  thumbnailUrl     String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  isPublic         Boolean            @default(false)
  documentType     String
  User             User               @relation(fields: [userId], references: [id])
  FavoriteDocument FavoriteDocument[]
  Presentation     Presentation?
}

model ChatConversation {
  id          String        @id
  userId      String
  title       String?
  context     String
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  User        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  ChatMessage ChatMessage[]

  @@index([context])
  @@index([userId])
}

model ChatMessage {
  id               String           @id
  conversationId   String
  userId           String
  role             String
  content          String
  metadata         Json?
  createdAt        DateTime         @default(now())
  ChatConversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId])
}

model CreditTransaction {
  id          String   @id
  userId      String
  amount      Int
  type        String
  description String
  operation   String?
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([type])
  @@index([userId])
}

model CustomTheme {
  id           String         @id
  name         String
  description  String?
  userId       String
  logoUrl      String?
  isPublic     Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  themeData    Json
  User         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  Presentation Presentation[]

  @@index([userId])
}

model DeepResearchReport {
  id             String   @id
  userId         String
  topic          String
  status         String
  filePath       String
  markdown       String
  pmidsUsed      Json?
  wordCount      Int?
  referenceCount Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

model Document {
  id        String   @id
  title     String
  content   String
  type      String
  sources   String?
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([userId])
}

model FavoriteDocument {
  id           String       @id
  documentId   String
  userId       String
  BaseDocument BaseDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User         User         @relation(fields: [userId], references: [id])
}

model GeneratedImage {
  id        String   @id
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime
  userId    String
  prompt    String
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}



model Presentation {
  id                String       @id
  content           Json
  theme             String       @default("default")
  imageSource       String       @default("ai")
  prompt            String?
  presentationStyle String?
  language          String?      @default("en-US")
  outline           String[]
  searchResults     Json?
  templateId        String?
  customThemeId     String?
  CustomTheme       CustomTheme? @relation(fields: [customThemeId], references: [id])
  BaseDocument      BaseDocument @relation(fields: [id], references: [id], onDelete: Cascade)
}

model TokenUsage {
  id            String   @id
  userId        String
  operation     String
  operationId   String?
  inputTokens   Int
  outputTokens  Int
  totalTokens   Int
  modelProvider String
  modelId       String
  inputCost     Float
  outputCost    Float
  totalCost     Float
  metadata      Json?
  createdAt     DateTime @default(now())
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([modelProvider])
  @@index([operation])
  @@index([userId, createdAt])
  @@index([userId])
}

model User {
  id                 String               @id
  name               String?
  email              String?              @unique
  password           String?
  emailVerified      DateTime?
  image              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now())
  headline           String?              @db.VarChar(100)
  bio                String?
  interests          String[]
  location           String?
  website            String?
  role               UserRole             @default(USER)
  hasAccess          Boolean              @default(false)
  credits            Int                  @default(100)
  totalInputTokens   Int                  @default(0)
  totalOutputTokens  Int                  @default(0)
  totalTokens        Int                  @default(0)
  totalTokenCost     Float                @default(0)
  lastCreditRefresh  DateTime?
  Account            Account[]
  BaseDocument       BaseDocument[]
  ChatConversation   ChatConversation[]
  ChatMessage        ChatMessage[]
  CreditTransaction  CreditTransaction[]
  CustomTheme        CustomTheme[]
  DeepResearchReport DeepResearchReport[]
  Document           Document[]
  FavoriteDocument   FavoriteDocument[]
  GeneratedImage     GeneratedImage[]
  TokenUsage         TokenUsage[]
  PdfDocument        PdfDocument[]
  PdfCollection      PdfCollection[]
  MedicalChunk       MedicalChunk[]
  MedicalEntity      MedicalEntity[]
  PdfChatSession     PdfChatSession[]
  // File Manager relations
  FileCollections    FileCollection[]
  UserFiles          UserFile[]

  @@index([lastCreditRefresh])
}

// =====================================================
// PDF Chat RAG Models
// =====================================================

model PdfDocument {
  id              String            @id @default(uuid()) @db.Uuid
  userId          String            @map("user_id")
  collectionId    String?           @map("collection_id") @db.Uuid
  filename        String
  originalName    String            @map("original_filename")
  fileUrl         String            @map("file_url")
  fileSize        Int               @map("file_size")
  pageCount       Int?              @map("page_count")
  status          String            @default("pending")
  processingError String?           @map("error_message")
  metadata        Json?
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  User            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  PdfCollection   PdfCollection?    @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  MedicalChunk    MedicalChunk[]
  MedicalEntity   MedicalEntity[]
  PdfChatSession  PdfChatSession[]

  @@index([userId])
  @@index([collectionId])
  @@index([status])
  @@index([createdAt])
  @@map("pdf_documents")
}

model MedicalChunk {
  id          String      @id @default(uuid()) @db.Uuid
  documentId  String      @db.Uuid
  userId      String
  chunkIdx    Int
  chunkText   String      @db.Text
  pageNumber  Int
  tokenCount  Int
  embedding   Unsupported("vector(768)")
  metadata    Json?
  createdAt   DateTime    @default(now())
  PdfDocument PdfDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([pageNumber])
}

model MedicalEntity {
  id              String      @id @default(uuid()) @db.Uuid
  documentId      String      @db.Uuid
  userId          String
  entityName      String
  entityType      String
  entityText      String
  startChar       Int?
  endChar         Int?
  confidenceScore Float       @default(0.8)
  createdAt       DateTime    @default(now())
  PdfDocument     PdfDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([entityType])
  @@index([entityName])
}

model PdfCollection {
  id                String           @id @default(uuid()) @db.Uuid
  userId            String           @map("user_id")
  name              String
  description       String?
  fileSearchStoreId String?          @map("file_search_store_id") // Gemini File Search Store ID
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  User              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  PdfDocument       PdfDocument[]
  PdfChatSession    PdfChatSession[]

  @@index([userId])
  @@index([createdAt])
  @@map("pdf_collections")
}

model PdfChatSession {
  id             String           @id @default(uuid()) @db.Uuid
  collectionId   String?          @map("collection_id") @db.Uuid
  documentId     String?          @map("document_id") @db.Uuid
  userId         String           @map("user_id")
  title          String?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  PdfCollection  PdfCollection?   @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  PdfDocument    PdfDocument?     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  User           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  PdfChatMessage PdfChatMessage[]

  @@index([collectionId])
  @@index([documentId])
  @@index([userId])
  @@index([createdAt])
  @@map("pdf_chat_sessions")
}

model PdfChatMessage {
  id              String         @id @default(uuid()) @db.Uuid
  sessionId       String         @map("session_id") @db.Uuid
  role            String
  content         String         @db.Text
  sources         Json?
  confidenceScore Float?         @map("confidence_score")
  createdAt       DateTime       @default(now()) @map("created_at")
  PdfChatSession  PdfChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("pdf_chat_messages")
}

enum DocumentType {
  NOTE
  DOCUMENT
  DRAWING
  DESIGN
  STICKY_NOTES
  MIND_MAP
  RAG
  RESEARCH_PAPER
  FLIPBOOK
  PRESENTATION
}

enum UserRole {
  ADMIN
  USER
}

// =====================================================
// File Manager Models
// =====================================================

model FileCollection {
  id                String                 @id @default(uuid()) @db.Uuid
  userId            String                 @map("user_id")
  name              String
  description       String?
  color             String                 @default("#3b82f6")
  icon              String                 @default("folder")
  isSmart           Boolean                @default(false) @map("is_smart")
  smartFilter       Json?                  @map("smart_filter")
  fileCount         Int                    @default(0) @map("file_count")
  // Share link fields
  shareLink         String?                @unique @map("share_link")
  shareLinkEnabled  Boolean                @default(false) @map("share_link_enabled")
  shareLinkAccess   String                 @default("public") @map("share_link_access")
  shareLinkRole     String                 @default("viewer") @map("share_link_role")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  User              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  UserFiles         UserFile[]
  FileCollectionFiles FileCollectionFile[]
  CollectionMembers CollectionMember[]
  CollectionPresence CollectionPresence[]

  @@index([userId])
  @@index([shareLink])
  @@map("file_collections")
}

model UserFile {
  id              String              @id @default(uuid()) @db.Uuid
  userId          String              @map("user_id")
  collectionId    String?             @map("collection_id") @db.Uuid
  // File info
  filename        String
  originalName    String              @map("original_name")
  fileUrl         String              @map("file_url")
  fileKey         String?             @map("file_key")
  storageProvider String              @default("wasabi") @map("storage_provider")
  fileType        String              @map("file_type")
  mimeType        String?             @map("mime_type")
  fileSize        Int                 @default(0) @map("file_size")
  thumbnailUrl    String?             @map("thumbnail_url")
  // Processing status
  status          String              @default("ready")
  processingError String?             @map("processing_error")
  isIndexed       Boolean             @default(false) @map("is_indexed")
  // Content extraction
  extractedText   String?             @map("extracted_text") @db.Text
  pageCount       Int?                @map("page_count")
  wordCount       Int?                @map("word_count")
  // AI metadata
  aiSummary       String?             @map("ai_summary") @db.Text
  aiCategory      String?             @map("ai_category")
  // User metadata
  isFavorite      Boolean             @default(false) @map("is_favorite")
  isGenerated     Boolean             @default(false) @map("is_generated")
  sourceFeature   String?             @map("source_feature")
  // Timestamps
  lastAccessedAt  DateTime?           @map("last_accessed_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  User            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  FileCollection  FileCollection?     @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  FileTags        FileTag[]
  FileChunks      FileChunk[]
  FileCollectionFiles FileCollectionFile[]

  @@index([userId])
  @@index([collectionId])
  @@index([fileType])
  @@index([isFavorite])
  @@index([isGenerated])
  @@index([createdAt])
  @@map("user_files")
}

model FileCollectionFile {
  id           String         @id @default(uuid()) @db.Uuid
  fileId       String         @map("file_id") @db.Uuid
  collectionId String         @map("collection_id") @db.Uuid
  addedAt      DateTime       @default(now()) @map("added_at")
  UserFile     UserFile       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  FileCollection FileCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([fileId, collectionId])
  @@index([fileId])
  @@index([collectionId])
  @@map("file_collection_files")
}

model FileTag {
  id            String   @id @default(uuid()) @db.Uuid
  fileId        String   @map("file_id") @db.Uuid
  tagName       String   @map("tag_name")
  tagType       String   @default("manual") @map("tag_type")
  confidence    Float    @default(1.0)
  color         String   @default("#6b7280")
  isAiGenerated Boolean  @default(false) @map("is_ai_generated")
  createdAt     DateTime @default(now()) @map("created_at")
  UserFile      UserFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([fileId, tagName])
  @@index([fileId])
  @@index([tagName])
  @@map("file_tags")
}

model FileChunk {
  id            String   @id @default(uuid()) @db.Uuid
  fileId        String   @map("file_id") @db.Uuid
  chunkIndex    Int      @map("chunk_index")
  content       String   @db.Text
  embedding     Unsupported("vector(1536)")?
  startPosition Int?     @map("start_position")
  endPosition   Int?     @map("end_position")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  UserFile      UserFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@map("file_chunks")
}

model CollectionMember {
  id           String         @id @default(uuid()) @db.Uuid
  collectionId String         @map("collection_id") @db.Uuid
  userId       String?        @map("user_id")
  email        String
  role         String         @default("viewer")
  status       String         @default("pending")
  invitedBy    String         @map("invited_by")
  invitedAt    DateTime       @default(now()) @map("invited_at")
  acceptedAt   DateTime?      @map("accepted_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  FileCollection FileCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, email])
  @@index([collectionId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@map("collection_members")
}

model CollectionPresence {
  id           String         @id @default(uuid()) @db.Uuid
  collectionId String         @map("collection_id") @db.Uuid
  odId         String         @map("user_id")
  userEmail    String?        @map("user_email")
  userName     String?        @map("user_name")
  userAvatar   String?        @map("user_avatar")
  lastSeen     DateTime       @default(now()) @map("last_seen")
  isActive     Boolean        @default(true) @map("is_active")
  FileCollection FileCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, odId])
  @@index([collectionId])
  @@index([isActive])
  @@map("collection_presence")
}

// =====================================================
// Video Streaming Models (Agora)
// =====================================================


// Groups System Models
// =====================================================


